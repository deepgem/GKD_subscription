name: 自动同步上游规则

on:
  schedule:
    # 北京时间每天凌晨 5:00 执行 (UTC 21:00)
    - cron: '0 21 * * *'
  workflow_dispatch: # 允许在 GitHub 页面手动点击运行

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: 检出代码
        uses: actions/checkout@v4
        with:
          # 必须使用你配置的 PAT，否则无法推送回仓库
          token: ${{ secrets.MY_PAT }}
          fetch-depth: 0 # 检出完整历史以进行对比和合并

      - name: 配置 Git 信息
        run: |
          git config --local user.name "XXX"
          git config --local user.email "你的邮箱@example.com"

      - name: 添加上游并检出源码
        run: |
          git remote add upstream https://github.com/AIsouler/GKD_subscription.git
          git fetch upstream main

          NEW_COMMITS=$(git log HEAD..upstream/main -- src/subscription.ts --oneline)

          if [ ! -z "$NEW_COMMITS" ]; then
            echo "错误：检测到上游对 src/subscription.ts 发布了新的改动："
            echo "$NEW_COMMITS"
            echo "为了保护你的定制逻辑不被破坏，自动更新已熔断停止，请手动检查代码。"
            exit 1
          fi

          echo "检查通过：上游未对入口文件进行修改，准备同步 App 规则。"

          git checkout upstream/main -- src/apps/
          git checkout upstream/main -- package.json pnpm-lock.yaml || true

      - name: 安装 Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: 安装 pnpm
        uses: pnpm/action-setup@v4

      - name: 安装依赖并重新构建
        run: |
          pnpm install
          pnpm build

      - name: 提交并推送变动
        run: |
          git add .

          git commit -m "chore(auto): 同步上游规则并重新构建" || true

          git push origin main
